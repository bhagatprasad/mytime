services:
  - type: web
    name: mytime-api
    env: python
    region: singapore
    plan: free
    branch: main
    rootDir: mytime-api
    
    # Build commands - SPECIAL FIX FOR RUST
    buildCommand: |
      echo "üöÄ Starting deployment with Rust workaround..."
      
      # 1. Install system dependencies first
      apt-get update
      apt-get install -y \
        g++ \
        unixodbc-dev \
        curl \
        gnupg \
        libssl-dev \
        libffi-dev
      
      # 2. Install Microsoft ODBC Driver
      curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
      curl https://packages.microsoft.com/config/debian/11/prod.list > /etc/apt/sources.list.d/mssql-release.list
      apt-get update
      ACCEPT_EULA=Y apt-get install -y msodbcsql17
      
      echo "üêç Installing Python packages..."
      
      # 3. Upgrade pip
      pip install --upgrade pip setuptools wheel
      
      # 4. Install packages in specific order to avoid Rust
      pip install fastapi==0.104.1
      pip install uvicorn[standard]==0.24.0
      pip install gunicorn==21.2.0
      pip install sqlalchemy==2.0.23
      pip install pyodbc==5.0.1
      pip install pydantic==2.5.3
      pip install pydantic-settings==2.1.0
      pip install python-dotenv==1.0.0
      pip install python-multipart==0.0.6
      pip install openai==1.6.1
      pip install httpx==0.25.1
      pip install requests==2.31.0
      
      # 5. Install auth packages WITHOUT Rust dependencies
      pip install python-jose==3.3.0
      pip install passlib==1.7.4  # No [bcrypt]
      pip install pycryptodome==3.20.0  # For JWT without Rust
      
      echo "‚úÖ All packages installed successfully!"
    
    # Start command - KEEP AS IS
    startCommand: gunicorn app.main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT
    
    # Environment variables - KEEP AS IS
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: "false"
      - key: PROJECT_NAME
        value: "MyTime - AI Integration API"
      - key: SECRET_KEY
        generateValue: true
      - key: ALLOWED_ORIGINS
        value: |
          [
            "https://mytime-api.onrender.com",
            "http://localhost:3000", 
            "http://localhost:4200",
            "http://localhost:8000"
          ]
      - key: DATABASE_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
    
    # Health check endpoint - KEEP AS IS
    healthCheckPath: /health
    
    # Auto-deploy on Git push - KEEP AS IS
    autoDeploy: true
