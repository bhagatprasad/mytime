services:
  - type: web
    name: mytime-api
    env: python
    region: singapore
    plan: free
    branch: main
    rootDir: mytime-api  # CRITICAL FIX: Your API is in mytime-api folder
    
    # Build commands - USING POETRY (since you have pyproject.toml)
    buildCommand: |
      echo "ðŸ Installing Poetry and dependencies..."
      pip install --upgrade pip
      pip install poetry
      
      # Install ODBC Driver for SQL Server (required for pyodbc)
      apt-get update && apt-get install -y g++ unixodbc-dev
      curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
      curl https://packages.microsoft.com/config/debian/11/prod.list > /etc/apt/sources.list.d/mssql-release.list
      apt-get update
      ACCEPT_EULA=Y apt-get install -y msodbcsql17
      
      # Install dependencies with Poetry
      poetry install --without dev
      
      echo "âœ… Dependencies installed"
    
    # Start command - Adjusted for Poetry
    startCommand: |
      cd mytime-api && poetry run gunicorn app.main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT
    
    # Environment variables
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0  # Match your pyproject.toml Python version
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: "false"
      - key: PROJECT_NAME
        value: "MyTime - AI Integration API"
      - key: SECRET_KEY
        generateValue: true
      - key: ALLOWED_ORIGINS
        value: |
          [
            "https://mytime-api.onrender.com",
            "http://localhost:3000", 
            "http://localhost:4200",
            "http://localhost:8000"
          ]
      - key: DATABASE_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Add PYTHONPATH if needed
      - key: PYTHONPATH
        value: "/opt/render/project/src/mytime-api"
    
    # Health check endpoint
    healthCheckPath: /health
    
    # Auto-deploy on Git push
    autoDeploy: true
